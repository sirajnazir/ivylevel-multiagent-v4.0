# ⭐ **IVYLEVEL MULTI–AGENT PLATFORM v4.0 — ARCHITECTURE OVERVIEW (v0.1)**

**Project:** `ivylevel-multiagents-v4`
**Status:** Baseline Architecture
**Audience:** Senior Engineers, AI Agent Contributors, System Architects

---

# 1. PURPOSE

This document defines the **end-to-end architecture** for the IvyLevel Multi-Agent Platform v4.0.

It establishes:

* The multi-layer system design
* The roles and boundaries of each module
* The agent orchestration model
* The intelligence sources (v4-native + v3-oracle)
* The knowledge flows
* The runtime architecture (task graph, state machines, evaluators)
* The codebase boundaries
* The 3P integrations
* The data schemas and storage
* The live interaction model (Realtime Assessment Twin pipeline)

---

# 2. TOP-LEVEL SYSTEM DIAGRAM

```
                      ┌───────────────────────────┐
                      │        FRONTEND APPS       │
                      │  (Web, Admin, Studio)      │
                      └───────────────┬────────────┘
                                      │
                                      ▼
                      ┌───────────────────────────┐
                      │         API LAYER          │
                      │ (REST, GraphQL, Webhooks)  │
                      └───────────────┬────────────┘
                                      │
                                      ▼
                     ┌──────────────────────────────┐
                     │       MULTI-AGENT RUNTIME     │
                     │    (Task Graph + Orchestrator)│
                     └──────────────┬───────────────┘
                                    │
          ┌─────────────────────────┼────────────────────────────┐
          │                         │                            │
          ▼                         ▼                            ▼
┌────────────────┐      ┌─────────────────────┐       ┌───────────────────────┐
│  Assessment     │      │   Planning Agent    │       │  Execution Agent       │
│   Agent         │      │   (roadmap logic)   │       │  (action execution)    │
└────────────────┘      └─────────────────────┘       └───────────────────────┘
          │                         │                            │
          └───────────────┬────────┴─────────────┬──────────────┘
                          ▼                      ▼                       
                ┌────────────────┐      ┌────────────────────────────────┐
                │   EQ Engine    │      │     V4 Cognitive Layer         │
                │ (tone control) │      │  (core-logic functions)        │
                └────────────────┘      └────────────────────────────────┘
                          │                      │
                          └──────────────┬───────┘
                                         ▼
                         ┌──────────────────────────────────┐
                         │     KNOWLEDGE + MEMORY LAYER      │
                         │  (Postgres + Pinecone + Cache)    │
                         └──────────────────┬────────────────┘
                                            ▼
                        ┌─────────────────────────────────────┐
                        │       v3 INTELLIGENCE ORACLES       │
                        │ (IvyScore, WeakSpots, Narrative)    │
                        └─────────────────────────────────────┘
```

---

# 3. ARCHITECTURAL PRINCIPLES

1. **Multi-Agent First**
   Every capability is implemented as an autonomous agent or micro-agent.

2. **Orchestration Core**
   All agents operate via a shared task-graph runtime with state machines.

3. **v3 Intelligence as Oracles**
   v3.3.5 domain logic = read-only sources of truth.

4. **Strong Boundary Enforcement**
   Modules cannot reach across layers without explicit adapters.

5. **Deterministic Data Path**
   Facts → chips → reasoning → evaluation → output schema.

6. **Zero Logic Duplication**
   One source of truth for every business rule.

7. **3P Heavy**
   Use OpenAI, Pinecone, Cohere, Retell, AssemblyAI whenever they outperform custom code.

---

# 4. LAYERED ARCHITECTURE

---

## **4.1 Application Layer (`/apps`)**

### Responsibilities:

* User interfaces (student, parent, coach)
* Studio tools (agent replay, eval dashboards)
* Assessment Twin live experience
* Admin tools

### Modules:

* `web/` — primary web UI
* `admin/` — internal operations UI
* `studio/` — agent debugging and telemetry

---

## **4.2 API Layer (`/packages/api`)**

### Responsibilities:

* HTTP interface for UI apps
* GraphQL interface for structured querying
* OpenAPI contract for external integrations
* Webhook endpoints for real-time events (Retell, AssemblyAI)

### Capabilities:

* Authentication
* Session creation
* Agent request API
* Orchestrator endpoints
* Knowledge retrieval
* Evaluation report delivery

---

## **4.3 Multi-Agent Runtime (`/packages/orchestrator`)**

This is the **core of v4.0**.

### Responsibilities:

* Agent registration
* Task graph execution
* Subtask decomposition
* Context propagation
* State transitions
* Error boundaries
* Performance tracing
* Safeguard logic
* Model routing (OpenAI, Anthropic)

### Components:

#### 1. **Router**

Agents → Orchestrator → Tools → Knowledge → Oracles → Return

#### 2. **Task Graph Engine**

Encodes agent behavior:

```
nodes:
  - extract_profile
  - compute_weakspots
  - narrative_phase
edges:
  extract_profile → compute_weakspots → narrative_phase
```

#### 3. **Agent Registry**

Each agent defines:

* state machine
* capabilities
* input schema
* output schema

#### 4. **Message Bus**

Inter-agent communication contract.

---

## **4.4 Agents Layer (`/packages/agents`)**

Contains modular agents:

### **Assessment Agent (Jenny Twin)**

* Live assessment state machine
* Transcript ingestion
* Profile extraction
* Diagnostics
* Narrative generation
* Summary object production

### **Planning Agent**

* Converts AOO → roadmap
* Aligns short-term vs long-term actions

### **Execution Agent**

* Converts actions → schedules
* Integrates with Google Calendar
* Sends action reminders

### **Empathy Agent**

* Tone calibration
* EQ mirroring
* Parent-coach dynamics

Each agent is:

* versioned
* spec-defined
* stateful only inside runtime
* deterministic through schemas

---

## **4.5 Cognitive Layer (`/packages/core-logic`)**

### Functions:

* Pattern matching
* Archetype classification
* Identity inference
* Narrative builder
* Award/program alignment
* Risk profiling
* Summer strategy modeling

This layer contains **no business data** — only pure logic.

---

## **4.6 Knowledge Layer (`/packages/knowledge`)**

### Components:

* **Postgres** — relational structured facts
* **Pinecone** — embeddings database
* **Cache (Redis)** — runtime state + memoization
* **Rerank (Cohere)** — relevance scoring
* **Embeddings pipeline**
* **Transcript processors** (AssemblyAI)

### Artifacts stored here:

* Student chips
* Transcripts
* Coach exemplar datasets
* Narrative patterns
* Award/program catalogs
* Evaluation datasets

---

## **4.7 v3 Intelligence Oracles (`/packages/adapters/v3-intelligence-oracles`)**

### Oracles Provided:

* IvyScore
* WeakSpots
* NarrativeEngine
* EQEngine
* StudentSnapshot

### Rules:

* Read-only
* Deterministic
* Schema-conforming
* Versioned

Agents use these as “truth sources.”

---

## **4.8 Memory Layer**

### Types:

* **Session Memory** — ephemeral, per agent run
* **Semantic Memory** — embeddings & KB
* **Episodic Memory** — durable history
* **Shared Memory** — cross-agent context

---

# 5. DATA FLOW DIAGRAMS

---

## **5.1 Live Assessment Session (Realtime)**

```
Audio → Retell/AssemblyAI → Transcript Stream  
                     ↓  
               Assessment Agent
                     ↓  
          Task Graph (Phase 1 → Phase 5)
                     ↓  
          v3 Oracles (rigor, narrative, weakspots)
                     ↓  
         Knowledge Layer (facts, chips, patterns)
                     ↓  
           Cognitive Layer (synthesis)
                     ↓  
  Assessment Output Object (schema v1.0)
                     ↓  
              Saved to Postgres
```

---

## **5.2 Offline Transcript → Assessment**

```
Transcript → kb.loader → fact extractor  
              ↓  
       Assessment Agent (offline mode)
              ↓  
         Diagnoser + Narrative
              ↓  
     AssessmentOutput_v1 schema object
              ↓  
        Stored + returned to UI
```

---

# 6. INTELLIGENCE SOURCES

### 1. **Native v4 Agents**

* reasoning
* narrative building
* adaptive flows

### 2. **v3 Oracles**

* scoring
* weakspot logic
* identity heuristics

### 3. **Exemplar-Based Learning**

* Jenny transcripts
* Jenny game plans you uploaded
* Patterns encoded into KB embeddings

### 4. **3P AI Providers**

* OpenAI Realtime
* OpenAI structured outputs
* Cohere rerank
* Pinecone vector search
* AssemblyAI transcription

---

# 7. SAFETY AND EVALUATION

### Layers of safety:

* schema validation
* oracle response validation
* agent evaluator
* task-graph guardrails
* tone moderation
* parent-management logic

### Evaluation metrics:

* coverage completeness
* accuracy vs Jenny baselines
* correctness of diagnostics
* narrative coherence
* empathy tone match
* actionability

---

# 8. VERSIONING STRATEGY

### Versions:

```
v4.0.0-alpha   → skeleton only  
v4.0.0-beta    → Assessment Twin running  
v4.1.x         → Planning Agent + cross-agent integration  
v4.2.x         → Execution Agent + UI Agent  
v4.3.x         → Twins for additional coaches  
v4.4.x         → Decommission v3 modules  
```

---

# 9. 3P INTEGRATION MAP

### OpenAI:

* Realtime agent runtime
* Structured outputs
* Fine-tuning
* Embeddings
* Tools/Actions

### Pinecone:

* Coach exemplar embeddings
* Student memory
* RAG index

### Cohere:

* Reranking
* Evaluation scoring

### AssemblyAI:

* Transcripts
* Block-level segmentation

### Retell:

* Voice interface
* Turn-taking

---

# 10. FUTURE-PROOFING

This architecture supports:

* Digital clones for all coaches
* Multi-agent swarms for complex tasks
* Autonomous execution loops
* Parent-persona-aware interactions
* Real-time adaptive student coaching
* Multi-coach cross-evaluation
* Deep personalization
* Long-term student trajectories
* Scaling to 10k+ concurrent users

---

# ⭐ **v4.0 Architecture Doc v0.1 COMPLETE**

